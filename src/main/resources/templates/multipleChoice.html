{#include base.html}
{#title}multiple Choice Modus{/title}

    {#scripts}
    <script src="js/multipleChoice/MultipleChoiceService.js"></script>
    <script src="js/multipleChoice/OptionMessage.js"></script>
    <script src="js/multipleChoice/QuizStartMessage.js"></script>
    <script src="js/multipleChoice/QuizUIService.js"></script>
    <script src="js/multipleChoice/MultipleChoiceQuizMessage.js"></script>
    <script src="js/multipleChoice/MultipleChoiceQuestion.js"></script>
        <script src="js/multipleChoice/QuizEnd.js"></script>
    {/scripts}
    {#styles}
        <link rel="stylesheet" href="styles/mcStyle.css">
    {/styles}
    {#onLoad}
    document.getElementById("input").focus();
        const quizUIService = new QuizUIService(uiService, multipleChoiceService, [{#for lecture in lectures}{| { |}"name":"{lecture.name}", "id":"{lecture.id}"{| } |},{/for}]);
        input.disabled = true;
    {/onLoad}
    {#eventListener}
        const multipleChoiceService = new MultipleChoiceService();
        const markdownParser = new MarkdownParser();

        // Verhindert XSS
        function sanitizeString(str) {
        return str.replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
        .replace(/`/g, "&#96;");
        }

        // Eventlistener für das Absenden einer Nachricht bei Click auf Button
        send.addEventListener('click', async function() {
        if (input.value === ''){

        } else{
        handleSendEvent();
        }
        });

        // Eventlistener für das Absenden einer Nachricht bei Enter
        input.addEventListener('keyup', async function(event) {
        if(input.value !== ''){
        if(event.key === 'Enter' && event.shiftKey){
        input.value += '\n';
        }
        else if (event.key === 'Enter' && !event.shiftKey) {
        handleSendEvent();
        }
        }
        });

        async function handleSendEvent() {
        // wandelt mögliche Sonderzeichen des Inputs um sodass diese nicht formatiert werden
        let inputText = sanitizeString(input.value);

        // Fügt die Message des Users der UI hinzu
        uiService.addMessage(new Message(null,inputText, 'user'));

        // Erstellt eine LoadingMessage
        const loadingMessage = new LoadingMessage("");
        uiService.addMessage(loadingMessage);

        // Macht das Inputfeld leer, eine Zeile hoch und scrollt ans ende des Chat-Feldes
        input.value = '';
        input.style.height = 'auto';
        document.getElementById("scroller").scrollTo(0, document.getElementById("scroller").scrollHeight);

        // Hole die Antwort
        const answer = await multipleChoiceService.talkAboutResults(inputText);

        // Entferne die LoadingMessage
        uiService.removeMessage(loadingMessage.id);

        const formattedAnswer = markdownParser.parse(answer.answer);
        uiService.addMessage(new Message(null,formattedAnswer, 'ai'));
        }


    {/eventListener}
    {#inputText}Lernen wir heute...{/inputText}
    {#clearMessagesExtension}

        const quizUIService = new QuizUIService(uiService, multipleChoiceService, [{#for lecture in lectures}{| { |}"name":"{lecture.name}", "id":"{lecture.id}"{| } |},{/for}]);

    {/clearMessagesExtension}

{/include}